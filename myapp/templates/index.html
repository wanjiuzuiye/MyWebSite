{% extends 'layout.html' %}
{% load static %}

{% block css %}
<style>


</style>
{% endblock %}

{% block content %}
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row" style="margin-top: 5px;">
            <div class="col-md-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body dashboard-tabs p-0">
                  <ul class="nav nav-tabs px-4" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link active" id="overview-tab" data-bs-toggle="tab" href="#overview" role="tab" aria-controls="overview" aria-selected="true">总览</a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" id="sales-tab" data-bs-toggle="tab" href="#sales" role="tab" aria-controls="sales" aria-selected="false">今日访问情况</a>
                    </li>
                  </ul>
                  <div class="tab-content py-0 px-0">
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                      <div class="d-flex flex-wrap justify-content-xl-between">
                        <div class="d-flex border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-eye me-3 icon-lg text-success"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Total views</small>
                            <h5 class="me-2 mb-0">{{total_views}}</h5>
                            <!-- <span id="busuanzi_container_site_pv">
                              <span id="busuanzi_value_site_pv"></span> -->
                            </span>
                          </div>
                        </div>
                        <div class="d-flex border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-database  me-3 icon-lg text-warning"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Datas</small>
                            <h5 class="me-2 mb-0" id="#total_data">{{total_data}}</h5>
                          </div>
                        </div>
                        <div class="d-flex py-3 border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-cursor-pointer  me-3 icon-lg text-danger"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Used</small>
                            <h5 class="me-2 mb-0" id="total_used">{{total_used}}</h5>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                      <div class="d-flex flex-wrap justify-content-xl-between">
                        <div class="d-flex border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-eye me-3 icon-lg text-success"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Today views</small>
                            <h5 class="me-2 mb-0" id="today_views">{{today_views}}</h5>
                          </div>
                        </div>
                        <div class="d-flex border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-database  me-3 icon-lg text-warning"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Datas</small>
                            <h5 class="me-2 mb-0" id="today_data">{{today_data}}</h5>
                          </div>
                        </div>
                        <div class="d-flex py-3 border-md-right flex-grow-1 align-items-center justify-content-center p-3 item">
                          <i class="mdi mdi-cursor-pointer  me-3 icon-lg text-danger"></i>
                          <div class="d-flex flex-column justify-content-around">
                            <small class="mb-1 text-muted">Used</small>
                            <h5 class="me-2 mb-0" id="today_used">{{today_used}}</h5>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top: 25px;">
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">七日内总览情况</p>
                  <!-- <div id="cash-deposits-chart-legend" class="d-flex justify-content-center pt-3"></div>
                  <canvas id="cash-deposits-chart"></canvas> -->
                  <div id="chartest" style="width: 100%;height: 450px;"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">今日浏览量与今日数据量占比</p>
                  <!-- <p class="mb-4">各类型操作次数如下</p>
                  <div id="total-sales-chart-legend"></div>                   
                </div>
                <canvas id="total-sales-chart"></canvas>
                -->
                <div id="chartest2" style="width: 100%;height: 450px;"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
        <!-- partial -->
      </div>
{% endblock %}

{% block js %}
  <!-- Plugin js for this page-->
  <script src="{% static 'plugins/vendors/chart.js/Chart.min.js' %}"></script>
  <script src="{% static 'plugins/vendors/datatables.net/jquery.dataTables.js' %}"></script>
  <script src="{% static 'plugins/vendors/datatables.net-bs4/dataTables.bootstrap4.js' %}"></script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="{% static 'js/echarts.min.js' %}"></script>
  <!-- End plugin js for this page-->

    <!-- Custom js for this page-->
    <script src="{% static 'js/dashboard.js' %}"></script>
    <script src="{% static 'js/data-table.js' %}"></script>
    <script src="{% static 'js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'js/dataTables.bootstrap4.js' %}"></script>
    <!-- End custom js for this page-->
  
    <script src="{% static 'js/jquery.cookie.js' %}" type="text/javascript"></script>
    <!-- 图标javascript代码 -->
    <script type="text/javascript">
          //获取数据
          $(document).ready(function(){
            $.ajax({
              url: "/",
              type: "GET",
              dataType: "json",
              success: function (data) {
                let current_views = []
                let current_datas = []
                let current_used = []
                let index = 0;
                let views = data.views_data_list;
                let datas = data.datas_data_list;
                let used = data.used_data_list;
                console.log(views);
                // 基于准备好的dom，初始化echarts实例
                var myChart = echarts.init(document.getElementById('chartest'));

                  //根据浏览器尺寸变化动态调整图形尺寸
                  window.addEventListener('resize', function() {
                    myChart.resize();
                  });

                  // 指定图表的配置项和数据
                  var option = {
                  tooltip: {
                      trigger: 'axis',
                  },
                  legend: {
                      data: ['总浏览量', '总数据量', '总操作数']
                    },
                  xAxis: {
                      type: 'category',
                      data: [],
                    },
                  yAxis: {
                      type: 'value',
                  },
                  series: [
                      {
                        name: '总浏览量',
                        type: 'line',
                        data: [],
                      },
                      {
                        name: '总数据量',
                        type: 'line',
                        data: [],
                      },
                      {
                        name: '总操作数',
                        type: 'line',
                        data: [],
                      },
                    ]
                  };

                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option,true);

                //更新函数
                function updateChart() {
                  // 更新数据列表
                  if (current_views.length >= 7) {
                    current_views.shift();
                    current_used.shift();
                    current_datas.shift();
                  }
                  if (index < views.length) {
                    current_views.push(views[index]);
                    current_used.push(used[index]);
                    current_datas.push(datas[index]);
                    index++;
                  } else { // 超出范围则重新开始
                    index = 0;
                    current_views.push(views[index]);
                    current_used.push(used[index]);
                    current_datas.push(datas[index]);
                  } 
                  option.xAxis.data = current_views.map(item => item.time);
                  option.series[0].data = current_views.map(item => item.value);
                  option.series[1].data = current_datas.map(item => item.value);
                  option.series[2].data = current_used.map(item => item.value);
                  myChart.setOption(option);
                }

                //定义计时器
                setInterval(updateChart, 1000);

              },
              error: function (xhr, status, error) {
                console.error("Error:", error);
              }
            });
          });
    </script>
    <script type="text/javascript">
          $(document).ready(function(){
            $.ajax({
              url: "/",
              type: "GET",
              dataType: "json",
              success: function (data) {
                //获取数据
                let today_views = data.today_views;
                let today_datas = data.today_datas;
                let not_today_views = data.not_today_views;
                let not_today_datas = data.not_today_datas
                console.log(today_views);

                var chartDom = document.getElementById('chartest2');
                var myChart2 = echarts.init(chartDom);
                var option;

                option = {
                  tooltip: {
                    trigger: 'item',
                  },
                  legend: {
                    data: [
                      '今日浏览',
                      '非今日浏览',
                      '今日数据',
                      '非今日数据',
                    ]
                  },
                  series: [
                    {
                      type: 'pie',
                      selectedMode: 'single',
                      radius: [0, '30%'],
                      label: {
                        position: 'inner',
                        fontsize: 14,
                      },
                      labelLine: {
                        show: false
                      },
                      data: [
                        { value: today_views, name: '今日浏览' },
                        { value:  not_today_views, name: '非今日浏览' },
                      ]
                    },
                    {
                      type: 'pie',
                      radius: ['45%', '60%'],
                      labelLine: {
                        length: 30
                      },
                      data: [
                        { value: today_datas, name: '今日数据' },
                        { value: not_today_datas, name: '非今日数据' },
                      ]
                    }
                  ]
                };

                option && myChart2.setOption(option);
              },
              error: function (xhr, status, error) {
                console.error("Error:", error);
              }
            });
          });

    </script>

{% endblock %}

